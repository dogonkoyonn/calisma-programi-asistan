rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ==================== HELPER FUNCTIONS ====================

    // Kullanıcı giriş yapmış mı?
    function isAuthenticated() {
      return request.auth != null;
    }

    // Döküman sahibi mi?
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // Geçerli timestamp mı?
    function isValidTimestamp(field) {
      return field is timestamp || field == request.time;
    }

    // ==================== USERS COLLECTION ====================

    match /users/{userId} {
      // Kullanıcı kendi profilini okuyabilir ve yazabilir
      allow read: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    // ==================== TODOS COLLECTION ====================

    match /todos/{todoId} {
      // Sadece kendi görevlerini okuyabilir
      allow read: if isAuthenticated() &&
                    resource.data.userId == request.auth.uid;

      // Yeni görev oluştururken userId kendisi olmalı
      allow create: if isAuthenticated() &&
                      request.resource.data.userId == request.auth.uid;

      // Güncellerken userId değiştirilemez
      allow update: if isAuthenticated() &&
                      resource.data.userId == request.auth.uid &&
                      request.resource.data.userId == request.auth.uid;

      // Sadece kendi görevlerini silebilir
      allow delete: if isAuthenticated() &&
                      resource.data.userId == request.auth.uid;
    }

    // ==================== STUDY PROGRAMS COLLECTION ====================

    match /studyPrograms/{programId} {
      allow read: if isAuthenticated() &&
                    resource.data.userId == request.auth.uid;

      allow create: if isAuthenticated() &&
                      request.resource.data.userId == request.auth.uid;

      allow update: if isAuthenticated() &&
                      resource.data.userId == request.auth.uid &&
                      request.resource.data.userId == request.auth.uid;

      allow delete: if isAuthenticated() &&
                      resource.data.userId == request.auth.uid;
    }

    // ==================== STUDY LOGS COLLECTION ====================

    match /studyLogs/{logId} {
      allow read: if isAuthenticated() &&
                    resource.data.userId == request.auth.uid;

      allow create: if isAuthenticated() &&
                      request.resource.data.userId == request.auth.uid;

      allow update: if isAuthenticated() &&
                      resource.data.userId == request.auth.uid;

      allow delete: if isAuthenticated() &&
                      resource.data.userId == request.auth.uid;
    }

    // ==================== HEALTH TRACKING COLLECTION ====================

    match /healthTracking/{docId} {
      allow read: if isAuthenticated() &&
                    resource.data.userId == request.auth.uid;

      allow create: if isAuthenticated() &&
                      request.resource.data.userId == request.auth.uid;

      allow update: if isAuthenticated() &&
                      resource.data.userId == request.auth.uid;

      allow delete: if isAuthenticated() &&
                      resource.data.userId == request.auth.uid;
    }

    // ==================== EXPENSES COLLECTION ====================

    match /expenses/{docId} {
      allow read: if isAuthenticated() &&
                    resource.data.userId == request.auth.uid;

      allow create: if isAuthenticated() &&
                      request.resource.data.userId == request.auth.uid;

      allow update: if isAuthenticated() &&
                      resource.data.userId == request.auth.uid;

      allow delete: if isAuthenticated() &&
                      resource.data.userId == request.auth.uid;
    }

    // ==================== SETTINGS COLLECTION ====================

    match /settings/{userId} {
      allow read: if isOwner(userId);
      allow write: if isOwner(userId);
    }

    // ==================== SHARED DATA (Gelecek için) ====================

    // Paylaşılan veriler için kurallar (FAZ 7'de aktifleştirilecek)
    // match /sharedLists/{listId} {
    //   allow read: if isAuthenticated() &&
    //                 (resource.data.ownerId == request.auth.uid ||
    //                  request.auth.uid in resource.data.sharedWith);
    //   allow write: if isAuthenticated() &&
    //                  resource.data.ownerId == request.auth.uid;
    // }

    // ==================== DENY ALL OTHER ====================

    // Tanımlanmamış collection'lara erişimi engelle
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
